{
    "level": "paragraph",
    "abstract": [
        {
            "text": "Since 2015, with the restart of the LHC for its second run of data taking, the LHCb experiment has been empowered with a dedicated computing model to select and analyse calibration samples to measure the performance of the particle identification (PID) detectors and algorithms. The novel technique was developed within the framework of the innovative trigger model of the LHCb experiment, which relies on online event reconstruction for most of the datasets, reserving offline reconstruction to special physics cases. The strategy to select and process the calibration samples, which includes a dedicated data-processing scheme combining online and offline reconstruction, is discussed. The use of the calibration samples to measure the detector PID performance, and the efficiency of PID requirements across a large range of decay channels, is described. Applications of the calibration samples in data-quality monitoring and validation procedures are also detailed.",
            "paragraph_rank": 2,
            "section_rank": 1
        }
    ],
    "body_text": [
        {
            "text": "Introduction",
            "section_rank": 2
        },
        {
            "section": "Introduction",
            "text": "LHCb is a dedicated heavy flavour physics experiment at the LHC. Its main goal is to search for indirect evidence of new physics in CP-violating processes and rare decays of beauty and charm hadrons. Among other performance metrics, like excellent vertex resolution and good momentum and invariant-mass resolution, charged particle identification (PID) distinguishing electrons, muons, pions, kaons and protons traversing the detector is essential in the LHCb physics programme. The required performances range from the per mille misidentification probability of hadrons as muons in the study of the rare B (d,s) \u2192 \u03bc + \u03bc \u2212 decays [1][2][3][4][5][6][7], to the sub percent precision, over a wide kinematic range accurate, on the detector induced asymmetries for the ambitious programme of CP asymmetry measurements [8][9][10][11]. PID information is extensively used both in the trigger selection and in offline data analysis. This required the development of a dedicated computing model and a strategy to select suitable calibration samples, in order to measure the PID performance and assess systematic effects. A careful design of the computing model is strategical since, thanks to the variety and abundance of the calibration samples available at the LHC, the statistical uncertainty on the measured selection efficiencies is limited by the amount of computing resources allocated to the task rather than from irreducible experimental factors.",
            "paragraph_rank": 3,
            "section_rank": 2,
            "ref_spans": [
                {
                    "type": "bibr",
                    "ref_id": "b0",
                    "start": 630,
                    "text": "[1]",
                    "end": 633
                },
                {
                    "type": "bibr",
                    "ref_id": "b2",
                    "start": 633,
                    "text": "[2]",
                    "end": 636
                },
                {
                    "type": "bibr",
                    "ref_id": "b4",
                    "start": 636,
                    "text": "[3]",
                    "end": 639
                },
                {
                    "type": "bibr",
                    "ref_id": "b5",
                    "start": 639,
                    "text": "[4]",
                    "end": 642
                },
                {
                    "type": "bibr",
                    "ref_id": "b6",
                    "start": 642,
                    "text": "[5]",
                    "end": 645
                },
                {
                    "type": "bibr",
                    "ref_id": "b7",
                    "start": 645,
                    "text": "[6]",
                    "end": 648
                },
                {
                    "type": "bibr",
                    "ref_id": "b8",
                    "start": 648,
                    "text": "[7]",
                    "end": 651
                },
                {
                    "type": "bibr",
                    "ref_id": "b9",
                    "start": 814,
                    "text": "[8]",
                    "end": 817
                },
                {
                    "type": "bibr",
                    "ref_id": "b10",
                    "start": 817,
                    "text": "[9]",
                    "end": 820
                },
                {
                    "type": "bibr",
                    "ref_id": "b11",
                    "start": 820,
                    "text": "[10]",
                    "end": 824
                },
                {
                    "type": "bibr",
                    "ref_id": "b12",
                    "start": 824,
                    "text": "[11]",
                    "end": 828
                }
            ]
        },
        {
            "section": "Introduction",
            "text": "In \"Detector\" section, an overview of the LHCb detector is given, together with a summary of the PID calibration samples required in order to accomplish the physics goals of LHCb with Run 2 data (2015\u22122018). The article then focuses on the strategy to select and process PID calibration samples, including a description of the multivariate classifiers used to combine the response of calorimeters, RICH and muon system (\"Global particle identification\" section); the procedure to measure the PID performance using dedicated calibration samples, together with the techniques to determine the selection efficiency on hundreds of different decay channels, relying on a small number of calibration samples (\"Measuring PID performance\" section); the dedicated dataprocessing scheme combining online and offline reconstruction (\"Computing model for the calibration samples\" section); and the applications of the calibration samples to dataquality monitoring and validation (\"Data quality, monitoring and validation\" section). A brief summary and outlook are given in \"Conclusions\" section. While this article discusses the calibration samples specifically for charged particle identification, the general computing model and selection strategy is also being applied to other calibration samples in Run 2, such as those for tracking calibration and neutral pion and photon PID.",
            "paragraph_rank": 4,
            "section_rank": 2
        },
        {
            "text": "Detector",
            "section_rank": 3
        },
        {
            "section": "Detector",
            "text": "The LHCb detector is a single-arm forward spectrometer covering the pseudorapidity range 2 < \u03b7 < 5, designed for the study of particles containing b or c quarks [12,13]. The detector includes a high-precision tracking system consisting of a silicon-strip vertex detector surrounding the pp interaction region [14], a large-area silicon-strip detector located upstream of a dipole magnet with a bending power of about 4 Tm, and three stations of silicon-strip detectors and straw drift tubes [15] placed downstream of the magnet. The tracking system provides a measurement of momentum, p, of charged particles with a relative uncertainty that varies from 0.5% at low momentum to 1.0% at 200GeV/c. The minimum distance of a track to a primary vertex, the impact parameter, is measured with a resolution of (15+29/p T )\u03bcm, where p T is the component of the momentum transverse to the beam, in GeV/c. Photons, electrons and hadrons are identified by a calorimeter system (CALO) consisting of scintillating-pad and preshower detectors, an electromagnetic calorimeter and a hadronic calorimeter. Different types of charged hadrons are distinguished using information from two ring-imaging Cherenkov (RICH) detectors [16]. Muons are identified by a system composed of alternating layers of iron and multiwire proportional chambers [17].",
            "paragraph_rank": 5,
            "section_rank": 3,
            "ref_spans": [
                {
                    "type": "bibr",
                    "ref_id": "b13",
                    "start": 161,
                    "text": "[12,",
                    "end": 165
                },
                {
                    "type": "bibr",
                    "ref_id": "b14",
                    "start": 165,
                    "text": "13]",
                    "end": 168
                },
                {
                    "type": "bibr",
                    "ref_id": "b15",
                    "start": 309,
                    "text": "[14]",
                    "end": 313
                },
                {
                    "type": "bibr",
                    "ref_id": "b16",
                    "start": 491,
                    "text": "[15]",
                    "end": 495
                },
                {
                    "type": "bibr",
                    "ref_id": "b17",
                    "start": 1210,
                    "text": "[16]",
                    "end": 1214
                },
                {
                    "type": "bibr",
                    "ref_id": "b18",
                    "start": 1324,
                    "text": "[17]",
                    "end": 1328
                }
            ]
        },
        {
            "section": "Detector",
            "text": "The online event selection is performed by a trigger [18], which consists of a hardware stage, based on information from the calorimeter and muon systems, followed by a software stage, which applies a full event reconstruction. Since 2015, in between the hardware and software stages, a real-time procedure aiming at the alignment and calibration of the detector is performed [19], making use of a disk buffer [20]. Updated calibration parameters are made available for the online reconstruction, used in the trigger selection. Online calibration is of such high quality that it is also used for offline reconstruction, ensuring consistency between online and offline.",
            "paragraph_rank": 6,
            "section_rank": 3,
            "ref_spans": [
                {
                    "type": "bibr",
                    "ref_id": "b19",
                    "start": 53,
                    "text": "[18]",
                    "end": 57
                },
                {
                    "type": "bibr",
                    "ref_id": "b20",
                    "start": 376,
                    "text": "[19]",
                    "end": 380
                },
                {
                    "type": "bibr",
                    "ref_id": "b21",
                    "start": 410,
                    "text": "[20]",
                    "end": 414
                }
            ]
        },
        {
            "section": "Detector",
            "text": "The responses of the calorimeter, RICH, and muon systems, or their combinations, associated to each track in the reconstruction process are named for brevity PID variables. They can be used in selections to increase the signal purity of a sample, reducing the processing time devoted to the reconstruction of background events, often characterized by high multiplicity, and helping in fitting into the data storage constraints. Moreover they allow selections to avoid an explicit bias on quantities of physical interest, such as decay time [21,22].",
            "paragraph_rank": 7,
            "section_rank": 3,
            "ref_spans": [
                {
                    "type": "bibr",
                    "ref_id": "b22",
                    "start": 540,
                    "text": "[21,",
                    "end": 544
                },
                {
                    "type": "bibr",
                    "ref_id": "b23",
                    "start": 544,
                    "text": "22]",
                    "end": 547
                }
            ]
        },
        {
            "section": "Detector",
            "text": "The many contexts in which particle identification is exploited within the experiment and the difficulties in obtaining a perfect simulation for the PID detectors, motivate the development of techniques for measuring the PID performance in suitable PID calibration samples. These samples are datasets collected by LHCb where decay candidates have a kinematic structure that allows unambiguous identification of one of the daughters, without the use of any PID information from the calorimeter, RICH, or muon systems, so that they are unbiased from the particle identification point of view. Today, most LHCb physics analyses rely on calibration samples for the determination of PID efficiencies. In addition, these samples can be used to monitor time variations in performance, and to test new reconstruction algorithms.",
            "paragraph_rank": 8,
            "section_rank": 3
        },
        {
            "section": "Detector",
            "text": "The majority of physics analyses using data collected with the LHCb experiment rely on the physics quantities as reconstructed in the online trigger reconstruction. Still, physics analyses with special needs in terms of event reconstruction, searching for example for interactions of light nuclei or particles beyond the Standard Model with the detector [23], are able to reprocess offline the collected calibration datasets with dedicated reconstruction algorithms.",
            "paragraph_rank": 9,
            "section_rank": 3,
            "ref_spans": [
                {
                    "type": "bibr",
                    "ref_id": "b25",
                    "start": 354,
                    "text": "[23]",
                    "end": 358
                }
            ]
        },
        {
            "section": "Detector",
            "text": "In order to enable the measurement of selection efficiencies that combine trigger requirements on the online-computed PID variables and offline requirements of PID variables obtained through dedicated reconstruction algorithms, an innovative dedicated data-processing strategy has been designed. Calibration data are obtained through a real-time selection based on the online reconstruction without any requirement on PID variables. Each event belonging to the calibration samples is fully reconstructed independently both online and offline. The resulting reconstructed particles are then matched, allowing a measurement of the efficiency of requirements that combine the two reconstruction types as described in \"Measuring PID performance\" section.",
            "paragraph_rank": 10,
            "section_rank": 3
        },
        {
            "text": "Global particle identification",
            "section_rank": 4
        },
        {
            "section": "Global particle identification",
            "text": "The reconstruction algorithms of each of the PID detectors of the LHCb experiment are very different, but each of them allows the computation of a likelihood ratio between particle hypotheses for each reconstructed track [13]. The reconstruction algorithm of the RICH detectors provides the likelihood of the electron, muon, kaon, proton and deuteron hypotheses relative to the pion hypothesis. The calorimeter system provides the likelihood of electrons relative to the pion hypothesis. Finally, the muon system provides the likelihoods of the muon and non-muon hypotheses. The likelihood ratios of the three detector systems are combined into Combined Differential Log-Likelihoods (CombDLL) [13], which are used to define the selection criteria for the data analyses.",
            "paragraph_rank": 11,
            "section_rank": 4,
            "ref_spans": [
                {
                    "type": "bibr",
                    "ref_id": "b14",
                    "start": 221,
                    "text": "[13]",
                    "end": 225
                },
                {
                    "type": "bibr",
                    "ref_id": "b14",
                    "start": 693,
                    "text": "[13]",
                    "end": 697
                }
            ]
        },
        {
            "section": "Global particle identification",
            "text": "Selection strategies based on CombDLL and isMuon [24], a binary variable loosely identifying muons, are widely employed already at the trigger level [25].",
            "paragraph_rank": 12,
            "section_rank": 4,
            "ref_spans": [
                {
                    "type": "bibr",
                    "ref_id": "b26",
                    "start": 49,
                    "text": "[24]",
                    "end": 53
                },
                {
                    "type": "bibr",
                    "ref_id": "b27",
                    "start": 149,
                    "text": "[25]",
                    "end": 153
                }
            ]
        },
        {
            "section": "Global particle identification",
            "text": "Following recent developments in machine learning, more advanced classifiers have also been designed to combine the likelihoods ratios defined above with the informations from the tracking system, including the kinematic variables of the particle, and additional information from the PID detectors not entering the likelihood computation (e.g. the number of hits in the muon system shared among reconstructed tracks). The classifier with the widest application in this category, named ANNPID, was developed using Forward Feeding Artificial Neural Networks [26], structured as a Multi-Layer Perceptron (MLP) with a single hidden layer composed of roughly 20% more nodes than the input layer activated, through a sigmoid function. The network is trained minimizing the Bernoulli Cross-Entropy with Stochastic Gradient Descent as implemented in the TMVA package [26]. Bernoulli Cross-Entropy originated from information theory and is proportional to the likelihood of a perfect binary classification of the training sample [27]. Alternative implementations and training strategies are also being developed [28], but their treatment falls outside the scope of this paper. The training sample is obtained from abundant simulated decays of heavy hadrons that emulate the kinematic distributions of signal samples studied in several analyses. Depending on the arrangement of the input samples, on the quality of the simulation, and on the available number of simulated events, the response of the ANNPID algorithm can vary. As a consequence, the response of the ANNPID algorithms is provided in several tunings, some for general purpose, and others specialised for a particular analysis or kinematic range. The variables combined using the ANNPID classifiers are listed in Table 1.",
            "paragraph_rank": 13,
            "section_rank": 4,
            "ref_spans": [
                {
                    "type": "bibr",
                    "ref_id": "b28",
                    "start": 556,
                    "text": "[26]",
                    "end": 560
                },
                {
                    "type": "bibr",
                    "ref_id": "b28",
                    "start": 859,
                    "text": "[26]",
                    "end": 863
                },
                {
                    "type": "bibr",
                    "ref_id": "b29",
                    "start": 1020,
                    "text": "[27]",
                    "end": 1024
                },
                {
                    "type": "table",
                    "ref_id": "tab_0",
                    "start": 1766,
                    "text": "Table 1",
                    "end": 1773
                }
            ]
        },
        {
            "section": "Global particle identification",
            "text": "All of the input variables for the ANNPID classifiers are made immediately available to physics analyses, easing the development of new tunings and classification algorithms dedicated to single analyses. The many output variables of the detector reconstruction which are not used as input to ANNPID can be accessed or even regenerated, relying on the raw detector data stored on tape.",
            "paragraph_rank": 14,
            "section_rank": 4
        },
        {
            "text": "Measuring PID performance",
            "section_rank": 5
        },
        {
            "section": "Measuring PID performance",
            "text": "More than twenty exclusive trigger selections are designed to select pure samples of the five most common charged particle species that interact with the LHCb detector: protons, kaons, pions, muons and electrons [29]. Generally, low-multiplicity decay modes with large branching fractions are chosen in order to enhance the statistics and the purity and populate the tails in the distributions of the PID variables, which are of great relevance when computing misidentification probabilities. Completely reconstructed final states composed of charged particles only are preferred, as they are selected with high purity at LHCb. An overview of the modes utilised is given in Table 2.",
            "paragraph_rank": 15,
            "section_rank": 5,
            "ref_spans": [
                {
                    "type": "bibr",
                    "ref_id": "b30",
                    "start": 212,
                    "text": "[29]",
                    "end": 216
                },
                {
                    "type": "table",
                    "ref_id": "tab_1",
                    "start": 674,
                    "text": "Table 2",
                    "end": 681
                }
            ]
        },
        {
            "section": "Measuring PID performance",
            "text": "The assumption underlying the usage of the calibration samples is that the distribution of the particle identification variables is independent of the selection strategy. Simply avoiding explicit requirements on the PID variables is not sufficient to ensure this. In fact, the hardware trigger relies on information from the CALO and muon systems to reduce the rate at which the full detector is read out to around 1 MHz, while a first layer of the software trigger, running before the full event reconstruction, includes dedicated selection algorithms to identify high p T muons and muon pairs.  In order to avoid a pre-selection that biases the PID variables, the selection strategy of the calibration samples imposes requirements on the algorithms selecting the event in the previous trigger layers. Either the trigger algorithms do not rely on PID information, or the PID selection in the trigger is applied to one of the particles not used to measure the performance.",
            "paragraph_rank": 16,
            "section_rank": 5
        },
        {
            "section": "Measuring PID performance",
            "text": "Several of the selection strategies are implemented according to the so-called tag-andprobe model [17]. Taking the J/\u03c8 \u2192 \u03bc + \u03bc \u2212 decay as an example, -the tag-and-probe selection strategy relies on a list of well-identified tag muons of a certain charge and a list of probe tracks with opposite charge, selected avoiding any PID requirement. These are combined to form muon pairs with invariant-mass consistent with the J/\u03c8 mass, and ",
            "paragraph_rank": 17,
            "section_rank": 5,
            "ref_spans": [
                {
                    "type": "bibr",
                    "ref_id": "b18",
                    "start": 98,
                    "text": "[17]",
                    "end": 102
                }
            ]
        },
        {
            "section": "Measuring PID performance",
            "text": "The high momentum samples are primarily selected, while the low momentum samples are included to maximise the kinematic coverage as much as possible are then filtered further on the basis of the quality of the fit of the decay vertex, to form the final sample. To extend the p T range of the muons in the calibration samples to lower values, where the background from low momentum pions is difficult to reduce, the J/\u03c8 candidates can be combined with charged kaons to form B + \u2192 J/\u03c8K + candidates 1 , adding further kinematic constraints related to the B decay to the final filtering. Proton calibration samples are obtained from two different decay modes: 0 \u2192 p\u03c0 \u2212 and + c \u2192 pK \u2212 \u03c0 + . Since the visible 0 production cross section in LHCb is several orders of magnitude larger with respect to heavy flavour production, the yield collected at the trigger level exceeds the needs in terms of statistical precision on the particle identification. This would pose severe challenges for data storage. Therefore, a large fraction of these signal candidates is discarded by running the selection only on a randomly selected fraction of the events. In order to improve the kinematic coverage of the sample, the fraction of discarded events is defined differently in four bins of the proton transverse momentum (p T ), resulting in a higher retention rate in the less-populated high-p T region. The sample of + c decays is included to extend the p T coverage of the 0 samples. An abundant calibration sample for pions is provided by the decay K 0 s \u2192 \u03c0 + \u03c0 \u2212 , but the spectrum of the probe particles is much softer than what is typical for hadrons produced in heavy hadron decays. Charm hadron decays allow the kinematic range to be extended to higher transverse momenta, but the lower purity of the samples, due to the smaller production cross-section, requires additional care in the selection and background subtraction strategies. The decay D * + \u2192 D 0 \u03c0 + with D 0 \u2192 K \u2212 \u03c0 + represents the primary source of \u03c0 \u00b1 and K \u00b1 calibration samples. The soft pion produced in the strong decay of the D * + hadron allows to tag the flavour of the D 0 and therefore to distinguish the kaon and the pion produced in its decay without PID requirements on either of the two probe particles. Applying a requirement on the energy release in the D * + \u2192 D 0 \u03c0 + decay, which is expected to be small, enables the rejection of combinatorial background due to the erroneous combination of D 0 hadrons and pions produced in unrelated processes. Finally, the D + s \u2192 \u03c6\u03c0 + decay with \u03c6 \u2192 K + K \u2212 is a further source of kaons. This sample allows the kinematic range for kaons to be extended to lower momenta, as the \u03c6 constraint enables the kinematic requirements on the kaons to be loosened while retaining the purity.",
            "paragraph_rank": 18,
            "section_rank": 5
        },
        {
            "section": "Measuring PID performance",
            "text": "The residual background that cannot be rejected with an efficient selection strategy is statistically subtracted assigning a signed weight (named s Weight) to each decay candidate, as prescribed by the s Plot technique [30]. A fit to the invariant-mass of the decaying particle is performed for each calibration sample, defining a signal component for which the sample of probe tracks is known to be pure, and one or more background components of different nature. In several cases, two-dimensional fits are performed to account for additional background sources. The variables used in the two-dimensional fits are: the D 0 mass and D * + \u2212 D 0 mass difference for D * + \u2192 D 0 \u03c0 + ; the B + and J/\u03c8 masses for B + \u2192 J/\u03c8 \u2192 \u03bc + \u03bc \u2212 K + ; the \u03c6 and D + s masses for D + s \u2192 \u03c6\u03c0 + . The fit to each calibration sample is repeated (at least) twice; the first iterations have a large number of free parameters including the means and widths of the signal components and shape parameters of the background components, whereas the final iteration fixes all of the parameters apart from the normalisation of each component (such as signal, misidentified background and combinatorial background). The covariance matrix produced in the final fit is used to define a relation between the discriminant variables and a signal s Weight to be assigned to the daughter candidate. Correlations between the chosen discriminating variables and the PID variables do not play a significant role. Figure 1 illustrates the invariant-mass distributions for some of the calibration samples, as obtained from proton-proton collision data collected in 2015 corresponding to an integrated luminosity of 0.17 fb \u22121 . The corresponding kinematic distributions for the different species of probe particles are also shown.",
            "paragraph_rank": 19,
            "section_rank": 5,
            "ref_spans": [
                {
                    "type": "bibr",
                    "ref_id": "b31",
                    "start": 219,
                    "text": "[30]",
                    "end": 223
                },
                {
                    "type": "figure",
                    "start": 1473,
                    "text": "Figure 1",
                    "end": 1481
                }
            ]
        },
        {
            "section": "Measuring PID performance",
            "text": "The performance of the PID detectors to a traversing particle depends on the kinematics of the particle, the occupancy of the detectors (which may be different event-to-event and for different particle production mechanisms), and experimental conditions such as alignments, temperature, and gas pressure (which may modify the response of detectors across runs).",
            "paragraph_rank": 20,
            "section_rank": 5
        },
        {
            "section": "Measuring PID performance",
            "text": "One may assume that the response of a PID variable is fully parameterised by some known set of variables, such as the track momentum p (which is related to the Cherenkov angle in the RICH and to the energy deposited in the calorimeter) and the track multiplicity, the latter being given by the number of reconstructed tracks traversing the whole detector. By partitioning the sample with sufficient granularity in these parameterising variables, the PDF of the PID variable distribution does not vary significantly within each subset, such that the efficiency of a selection requirement on that variable is constant within each subset [40].",
            "paragraph_rank": 21,
            "section_rank": 5,
            "ref_spans": [
                {
                    "type": "bibr",
                    "ref_id": "b41",
                    "start": 635,
                    "text": "[40]",
                    "end": 639
                }
            ]
        },
        {
            "section": "Measuring PID performance",
            "text": "In the trivial case of events that come from the calibration sample, there is no need to compute per-subset efficiencies, and the average efficiency is simply given by the fraction of background subtracted events passing the PID requirement. To compute the PID efficiency on a sample other than the calibration sample, denoted hereafter as the reference sample, the parameterising variables in the calibration sample can be weighted to match those in the reference sample. The PID efficiency can then be computed using the persubset weights. The weights are defined as the normalised ratio of reference to calibration tracks",
            "paragraph_rank": 22,
            "section_rank": 5
        },
        {
            "section": "Measuring PID performance",
            "text": "where R i (C i ) is the number of reference (calibration) tracks in the ith subset, and R (C) is the total number of reference (calibration) tracks in the sample. After applying the PID cut to the weighted calibration sample, the average efficiency of the PID requirement on the weighted calibration sample is",
            "paragraph_rank": 23,
            "section_rank": 5
        },
        {
            "section": "Measuring PID performance",
            "text": "where w i is the per-subset weight, i is the per-subset efficiency and C i is the number of calibration tracks in the i-th subset. The computation of the PID efficiency can be thought of as the reweighting of the calibration sample to match the reference, or as the assignment of efficiencies to reference tracks based on the subset they belong to. This can also be extended to reference samples where PID requirements have been imposed on multiple tracks, where the efficiency of an ensemble of cuts is required taking into account the kinematic correlation between tracks.",
            "paragraph_rank": 24,
            "section_rank": 5
        },
        {
            "section": "Measuring PID performance",
            "text": "There are a number of ways in which the calibration samples can be used to determine PID efficiencies. Three broad strategies have been commonly implemented by LHCb in the past. The first uses a simulated reference sample to provide the kinematics of the Fig. 1 On the left, mass distributions of the decaying particles with the results of the fit superimposed; signal contributions are shown by the red dashed curves, and the total fit functions including background contributions are shown by the blue solid curves. On the right, the background-subtracted distributions of the calibration samples for electrons, muons, pions, kaons and protons as a function of the track pseudorapidity, \u03b7, and momentum p are shown. The colour scale units are arbitrary signal tracks under consideration. This is an ideal approach to use when the kinematics of the signal tracks are known to be well modelled in the simulation. If the signal in data can be reliably separated from the other species in the sample, such that some background subtraction can be used to extract the signal kinematics, a second approach to creating the reference sample can be used.",
            "paragraph_rank": 25,
            "section_rank": 5,
            "ref_spans": [
                {
                    "type": "figure",
                    "start": 255,
                    "text": "Fig. 1",
                    "end": 261
                }
            ]
        },
        {
            "section": "Measuring PID performance",
            "text": "Lastly, the PID response of MC signal samples can be corrected using the PID calibration data samples. Two options are provided:",
            "paragraph_rank": 26,
            "section_rank": 5
        },
        {
            "section": "Measuring PID performance",
            "text": "\u2022 Resampling of PID variables, where the PID response is completely replaced by the one statistically generated from calibration PDFs.",
            "paragraph_rank": 27,
            "section_rank": 5
        },
        {
            "section": "Measuring PID performance",
            "text": "\u2022 Transformation of PID variables, where the PID variables from the simulation are transformed such that they are distributed as in data.",
            "paragraph_rank": 28,
            "section_rank": 5
        },
        {
            "section": "Measuring PID performance",
            "text": "The PID correction is still considered as a function of track kinematics (p T and \u03b7) and event multiplicity N evt (such as the number of tracks in the event). However, unlike in the first two strategies detailed above, the correction is performed using an unbinned approach, where the calibration PDFs in four dimensions, the PID variable, p T , \u03b7, and a measure of N evt , are described by a kernel density estimation procedure using the Meerkat library [31]. The advantage of resampling and variable transformation is that the corrected PID response can be used as an input to a multivariate classifier.",
            "paragraph_rank": 29,
            "section_rank": 5,
            "ref_spans": [
                {
                    "type": "bibr",
                    "ref_id": "b32",
                    "start": 455,
                    "text": "[31]",
                    "end": 459
                }
            ]
        },
        {
            "section": "Measuring PID performance",
            "text": "However, a limitation of the PID resampling approach is that the PID variables for the same track are generated independently, and thus no correlations between them are reproduced. Therefore, only one PID variable per track can be used in the selection. Correlations between variables for different tracks are preserved via correlations with the kinematics of tracks, assuming the PID response is fully parameterised by p T , \u03b7, and N evt .",
            "paragraph_rank": 30,
            "section_rank": 5
        },
        {
            "section": "Measuring PID performance",
            "text": "The PID variable transformation approach aims to remove this limitation [32]. The corrected PID variable PID corr is obtained as",
            "paragraph_rank": 31,
            "section_rank": 5,
            "ref_spans": [
                {
                    "type": "bibr",
                    "ref_id": "b33",
                    "start": 72,
                    "text": "[32]",
                    "end": 76
                }
            ]
        },
        {
            "section": "Measuring PID performance",
            "text": "where",
            "paragraph_rank": 32,
            "section_rank": 5
        },
        {
            "section": "Measuring PID performance",
            "text": "is the cumulative distribution function of the simulated PID variable PID MC , and",
            "paragraph_rank": 33,
            "section_rank": 5
        },
        {
            "section": "Measuring PID performance",
            "text": "is the inverse cumulative distribution function for the PID variable from the calibration sample (i.e. for fixed p T , \u03b7 and N evt it returns the PID variable that corresponds to a cumulative probability x). The functions are obtained from the results of kernel density estimations of the simulation and calibration PID responses, respectively. The corrected PID variables obtained in this way follow the PDF of the calibration sample, but preserve strong correlations with the output of simulation. Through these correlations in simulation, the ones between PID variables for the same track are reproduced to first order. The drawback of this approach is that it also relies on the parametrisation of PID PDFs in simulation, which are extracted from samples that are typically much smaller than the calibration data. Although one naively expects this method to perform better due to taking correlations into account, studies are ongoing to quantify the degree of agreement between the correlations found in simulation and data. The PID resampling and variables transformation techniques are schematically represented in Fig. 2.",
            "paragraph_rank": 34,
            "section_rank": 5,
            "ref_spans": [
                {
                    "type": "figure",
                    "ref_id": "fig_1",
                    "start": 1121,
                    "text": "Fig. 2",
                    "end": 1127
                }
            ]
        },
        {
            "section": "Measuring PID performance",
            "text": "There are a number of sources of uncertainty that affect the measurement of PID efficiencies. The statistical uncertainty arises from finite statistics in the input samples used in the calibration procedure, namely the calibration and reference samples. Due to the Several sources of systematic uncertainty related to the procedure must also be accounted for, arising from differences between the reference and signal samples, the specific choice of binning used, and the s Weight procedure used in the calibration sample production. The degree to which these uncertainties affect the PID efficiency precision is analysis dependent, and require specific studies to be carried out on a case-by-case basis. Moreover the availability of primary and secondary calibration samples allows to study possible biases coming from single decay modes.",
            "paragraph_rank": 35,
            "section_rank": 5
        },
        {
            "text": "Computing model for the calibration samples",
            "section_rank": 6
        },
        {
            "section": "Computing model for the calibration samples",
            "text": "In order to face the new challenges of the second run of the LHC, the LHCb trigger [33,34] has evolved into a heterogeneous configuration with different output data formats for different groups of trigger selections. Figure 3 shows a schematic representation of the computing model that is described in the following.",
            "paragraph_rank": 36,
            "section_rank": 6,
            "ref_spans": [
                {
                    "type": "bibr",
                    "ref_id": "b34",
                    "start": 83,
                    "text": "[33,",
                    "end": 87
                },
                {
                    "type": "bibr",
                    "ref_id": "b35",
                    "start": 87,
                    "text": "34]",
                    "end": 90
                },
                {
                    "type": "figure",
                    "start": 217,
                    "text": "Figure 3",
                    "end": 225
                }
            ]
        },
        {
            "section": "Computing model for the calibration samples",
            "text": "Two alternative data formats for physics analyses, named Turbo stream [35] and Full stream, have been developed. Trigger selections writing to the Turbo stream are intended for analyses of samples where only the information related to the candidates and associated reconstructed objects is needed. Trigger selections that are part of the Turbo stream produce a decay candidate which is stored for offline analysis, along with a large number of detector-related variables, while the raw detector data is not kept [35,36]. When considering analyses based on the Turbo stream, it is therefore evident that the calibration samples must provide the PID information as computed online in order to assess the efficiency of selection requirements applied either in the trigger selection, or offline on the PID variables retrieved from the trigger candidate.",
            "paragraph_rank": 37,
            "section_rank": 6,
            "ref_spans": [
                {
                    "type": "bibr",
                    "ref_id": "b36",
                    "start": 70,
                    "text": "[35]",
                    "end": 74
                },
                {
                    "type": "bibr",
                    "ref_id": "b36",
                    "start": 512,
                    "text": "[35,",
                    "end": 516
                },
                {
                    "type": "bibr",
                    "ref_id": "b37",
                    "start": 516,
                    "text": "36]",
                    "end": 519
                }
            ]
        },
        {
            "section": "Computing model for the calibration samples",
            "text": "Trigger selections for events to be stored in the Full stream are intended for those measurements and searches for which the Turbo approach is not applied. While the software trigger fully reconstructs candidates, those are not saved. If the trigger decision is affirmative, the raw detector data is saved together with summary information on the trigger decision, including the CombDLL and isMuon variables, for each particle involved in the trigger decision. The track and decay candidates are reproduced in a further offline reconstruction step that accesses the raw detector data. Indeed, some physics data analyses present special needs in terms of particle identification algorithms, for example because they explore kinematic regions at the boundaries of the kinematic acceptance, or because of exceptional requirements in terms of the accuracy of the efficiency determination. To respond to such special requirements, dedicated algorithms accessing the raw detector data can be developed and included in the offline event reconstruction. Hence, the events selected as part of the calibration samples must include the raw data, allowing the performance of future algorithms to be measured on data. An interesting case is presented when a trigger selection targeting the Full stream includes PID requirements that are then intended to be refined offline. Potentially, the PID variables computed online can differ from those obtained from the full event reconstruction performed offline. While accidental differences in the online and offline algorithms are unlikely thanks to dedicated checks in the data quality validation procedure, the offline reconstruction is subject to improvements that provide a slightly different value for the PID variables. The determination of the efficiency of combined requirements on online and offline versions of the PID variables, or of different tunings of the multivariate classifiers adopted in the trigger and in the statistical data analysis, require the use of calibration samples combining the information from the online and offline reconstruction, allowing full offline reprocessing if needed.",
            "paragraph_rank": 38,
            "section_rank": 6
        },
        {
            "section": "Computing model for the calibration samples",
            "text": "A dedicated data format, named TurboCalib, was developed to satisfy the requirements on PID calibration samples described above [37]. After the online full event reconstruction, events in which decay candidates useful for calibration are identified and selected in real-time are stored including both the trigger candidates themselves and raw detector data. The two output formats are processed independently for each event, to obtain both decay candidates propagated from the trigger and decay candidates reconstructed offline from the raw detector data. The two reconstructions are fully independent, so that the tracks identified in the two processes must be matched. This is done according to the fraction of shared clusters in the detector, or exploiting the TisTos algorithm described in Ref. [38], or with a combination of the two techniques.",
            "paragraph_rank": 39,
            "section_rank": 6,
            "ref_spans": [
                {
                    "type": "bibr",
                    "ref_id": "b38",
                    "start": 128,
                    "text": "[37]",
                    "end": 132
                },
                {
                    "type": "bibr",
                    "ref_id": "b39",
                    "start": 799,
                    "text": "[38]",
                    "end": 803
                }
            ]
        },
        {
            "section": "Computing model for the calibration samples",
            "text": "The offline versions of the PID variables can be easily replaced with other tunings of the multivariate classifiers, or through the output of dedicated reconstruction sequences. As a result of the matching procedure, each reconstructed track is associated to two sets of PID variables, obtained through the online and offline versions of the reconstruction, respectively. The two sets are available to the analysts to measure the efficiency of selection requirements that possibly combine the two versions.",
            "paragraph_rank": 40,
            "section_rank": 6
        },
        {
            "section": "Computing model for the calibration samples",
            "text": "As described in \"Measuring PID performance\" section, the measurement of the selection efficiencies from the selected calibration samples is enabled through the subtraction of the residual background by means of the s Plot technique. In order to overcome to the scalability challenges set by the increasing needs for precision in many LHCb measurements, resulting in huge calibration samples to control the statistical uncertainty, the background subtraction is performed through a dedicated, distributed implementation of the s Plot technique. Finely binned histograms of the invariant-mass distributions of the trigger candidates are filled in parallel on thousands of computing nodes. They are then merged and modeled through a maximum likelihood fit as the combination of signal and background components. The relations between the discriminating variables and the s Weights to be assigned to each candidate are sampled in fine grids and made available through a distributed file system to the computing nodes of the LHCb grid [39], where jobs to assign the weights are run as a final processing step in the calibration sample production workflow. Such a distributed implementation of the s Plot technique avoids the storage of the entire dataset on a single computing node, hence scaling better with the size of the calibration samples.",
            "paragraph_rank": 41,
            "section_rank": 6,
            "ref_spans": [
                {
                    "type": "bibr",
                    "ref_id": "b40",
                    "start": 1030,
                    "text": "[39]",
                    "end": 1034
                }
            ]
        },
        {
            "section": "Computing model for the calibration samples",
            "text": "The real-time selection strategy, the double-processing scheme combining event-byevent the online and offline reconstructed variables, and the distributed approach to background subtraction constitute the main novelties in the data processing for the calibration samples, overcoming most scalability issues and making the limited cross-section and the available data storage resources the only limitations to the statistical precision in the determination of PID selection efficiencies.",
            "paragraph_rank": 42,
            "section_rank": 6
        },
        {
            "section": "Computing model for the calibration samples",
            "text": "Finally, the Particle IDentification Calibration (PIDCalib) package [40] is a user interface written in python aiming at a standardization of the techniques described in \"Measuring PID performance\" section to transfer the information on PID of the calibration samples to the reference sample of interest for the many physics analyses. It includes several reweighing approaches, PID resampling and PID variable transformation. The set of variables identifying the kinematics of the tracks, the event multiplicity and the PID response can be chosen case by case, while the access to calibration samples and the implementation of the algorithms are maintained centrally.",
            "paragraph_rank": 43,
            "section_rank": 6,
            "ref_spans": [
                {
                    "type": "bibr",
                    "ref_id": "b41",
                    "start": 68,
                    "text": "[40]",
                    "end": 72
                }
            ]
        },
        {
            "text": "Data quality, monitoring and validation",
            "section_rank": 7
        },
        {
            "section": "Data quality, monitoring and validation",
            "text": "As discussed in \"Measuring PID performance\" section, calibration samples are abundant decays with high purity which are selected at the trigger level. They are representative of all the families of long-lived charged particles interacting with the LHCb detector, apart from deuterons. Their immediate availability during the data taking and their high statistics are key ingredients for data-quality monitoring and validation. Since the reconstruction involves different systems of the LHCb detectors depending on the nature of the particle, the various samples are used to monitor and validate different aspects of the reconstruction. For example, the recovery of Bremsstrahlung photons to improve the momentum resolution of the electrons can only be monitored and validated using an electron sample. Similarly, the efficiency of muon identification can be better monitored and validated using a sample of tagged muons.",
            "paragraph_rank": 44,
            "section_rank": 7
        },
        {
            "section": "Data quality, monitoring and validation",
            "text": "In order to add redundancy to the validation procedure, a small fraction of the calibration samples are reconstructed with the offline procedure in real time. This enables alarms to be triggered when misalignments occur between the online and offline reconstruction, due to errors in the database handling the alignment and calibration constants, for example.",
            "paragraph_rank": 45,
            "section_rank": 7
        },
        {
            "section": "Data quality, monitoring and validation",
            "text": "Finally, several checks on the reconstructed quantities in the calibration samples have been included in the automated validation procedure performed during data taking. These aim to identify deviations from standard running conditions, and check for possible temporal variations in performance due to unstable environmental conditions, or ageing of the detector [41].",
            "paragraph_rank": 46,
            "section_rank": 7,
            "ref_spans": [
                {
                    "type": "bibr",
                    "ref_id": "b42",
                    "start": 363,
                    "text": "[41]",
                    "end": 367
                }
            ]
        },
        {
            "section": "Data quality, monitoring and validation",
            "text": "Real-time monitoring on pure decay samples representative of the needs of a wide physics programme will be of critical importance during Run 3 of the LHC, when, after a major upgrade of the LHCb experiment, most datasets to perform physics data analyses will be selected in the trigger and stored as decay candidates, with no support for raw detector data [36]. Since no further reprocessing of the reconstruction will be possible, any loss in performance will unavoidably result in a loss of effectiveness for the resulting physics measurements.",
            "paragraph_rank": 47,
            "section_rank": 7,
            "ref_spans": [
                {
                    "type": "bibr",
                    "ref_id": "b37",
                    "start": 356,
                    "text": "[36]",
                    "end": 360
                }
            ]
        },
        {
            "text": "Conclusions",
            "section_rank": 8
        },
        {
            "section": "Conclusions",
            "text": "The strategy to select and process the calibration samples used to measure the PID performance has seen several improvements to face the challenges set by Run 2 of the LHC. The samples are now selected directly in real-time at the highest level of the software trigger, introducing an important benefit in terms of statistics and absence of selection bias with respect to the offline selection strategy adopted in Run 1. The calibration samples are used to measure the PID performance, to correct the simulated samples, and to monitor the detector performance during the data-taking.",
            "paragraph_rank": 48,
            "section_rank": 8
        },
        {
            "section": "Conclusions",
            "text": "The computing model to manage and process the calibration samples has been redesigned in order to overcome the scalability challenges set by the larger statistics needed to investigate the PID performance for the LHC Run 2.",
            "paragraph_rank": 49,
            "section_rank": 8
        },
        {
            "text": "track fit Number of clusters associated to the track ANN response trained to reject ghost tracks [42] Quality of the fit matching track segments upstream and downstream of the magnet RICH detectors Geometrical acceptance of the three radiators, depending on the direction of the track Kinematical acceptance due to Cherenkov threshold for muons and kaons Likelihood of the electron, muon, kaon, and proton hypotheses relative to the pion Likelihood ratio of the below-threshold and pion hypotheses Electromagnetic calorimeter Likelihood ratio of the electron and hadron hypotheses Likelihood ratio of the muon and hadron hypotheses Matching of the track with the clusters in the preshower detector Likelihood ratio of the electron and pion hypotheses, after recovery of the Bremsstrahlung photons Hadronic calorimeter Likelihood ratio of the electron and hadron hypotheses Likelihood ratio of the muon and hadron hypotheses Muon system Geometrical acceptance Loose binary requirement already available in the hardware trigger Likelihood of the muon hypothesis Likelihood of the non-muon hypothesis Number of clusters associated to at least another track",
            "paragraph_rank": 50,
            "section_rank": 9
        },
        {
            "text": "Fig. 2",
            "section_rank": 10
        },
        {
            "section": "Fig. 2",
            "text": "Fig. 2 Schematic representation of the PID resampling and variable transformation techniques",
            "paragraph_rank": 51,
            "section_rank": 10
        },
        {
            "text": "16 Fig. 3",
            "section_rank": 11
        },
        {
            "section": "16 Fig. 3",
            "text": "Fig. 3Schematic representation of the computing model for the PID calibration samples",
            "paragraph_rank": 52,
            "section_rank": 11
        },
        {
            "text": "Table 1",
            "section_rank": 12
        },
        {
            "section": "Table 1",
            "text": "Input variables of the ANNPID classifiers for the various subsystems of the LHCb detector",
            "paragraph_rank": 53,
            "section_rank": 12
        },
        {
            "text": "Table 2",
            "section_rank": 13
        },
        {
            "section": "Table 2",
            "text": "Overview of decay modes that are used to select calibration samples J/\u03c8K + with J/\u03c8 \u2192 e + e \u2212 \u03bc",
            "paragraph_rank": 54,
            "section_rank": 13
        },
        {
            "section": "Table 2",
            "text": "\u00b1 B +",
            "paragraph_rank": 55,
            "section_rank": 13
        },
        {
            "text": "Acknowledgements",
            "section_rank": 15
        },
        {
            "section": "Acknowledgements",
            "text": "We express our gratitude to our colleagues in the CERN accelerator departments for the excellent performance of the LHC. We thank the technical and administrative staff at the LHCb institutes. We acknowledge support from CERN and from the national agencies: CNRS/IN2P3 (France); INFN (Italy); NWO (The Netherlands); MinECo (Spain); SNSF and SER (Switzerland); STFC (United Kingdom); We acknowledge the computing resources that are provided by CERN, IN2P3 (France), INFN (Italy), SURF (The Netherlands), PIC (Spain), GridPP (United Kingdom), CSCS (Switzerland). We are indebted to the communities behind the multiple open-source software packages on which we depend.",
            "paragraph_rank": 56,
            "section_rank": 15
        },
        {
            "text": "The new scheme has been later adopted to provide the tracking and the photon reconstruction performance, paving the way for Run 3.",
            "paragraph_rank": 57,
            "section_rank": 17
        },
        {
            "text": "Endnote",
            "section_rank": 18
        },
        {
            "section": "Endnote",
            "text": "1 Charged-conjugated candidates are implicitly considered here and throughout the paper. ",
            "paragraph_rank": 58,
            "section_rank": 18
        },
        {
            "text": "Consent for publication",
            "section_rank": 19
        },
        {
            "section": "Consent for publication",
            "text": "Not applicable.",
            "paragraph_rank": 59,
            "section_rank": 19
        },
        {
            "text": "Competing interests",
            "section_rank": 20
        },
        {
            "section": "Competing interests",
            "text": "The authors declare that they have no competing interests.",
            "paragraph_rank": 60,
            "section_rank": 20
        },
        {
            "text": "Publisher's Note",
            "section_rank": 21
        },
        {
            "section": "Publisher's Note",
            "text": "Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.",
            "paragraph_rank": 61,
            "section_rank": 21
        },
        {
            "text": "Author details",
            "section_rank": 22
        },
        {
            "section": "Author details",
            "text": "1 Aix Marseille Univ, CNRS/IN2P3, CPPM, Marseille, France. 2 LAL, Universit\u00e9 Paris-Sud, CNRS/IN2P3, Universit\u00e9 Paris-Saclay, Orsay, France. 3 Universit\u00e9 Pierre et Marie Curie, Universit\u00e9 Paris Diderot, CNRS/IN2P3, Paris, France. 4 Istituto Nazionale di Fisica Nucleare, Sezione di Bologna, Bologna, Italy. 5 Istituto Nazionale di Fisica Nucleare, Sezione di Firenze, Florence, Italy. 6 Istituto Nazionale di Fisica Nucleare, Laboratori Nazionali di Frascati, Frascati, Italy. 7 European Organization for Nuclear Research (CERN), Meyrin, Switzerland. 8 Nikhef, Amsterdam, Netherlands. 9 University of Cambridge, Cambridge, United Kingdom. 10 Department of Physics, University of Warwick, Coventry, United Kingdom. 11 Imperial College London, London, United Kingdom. 12 University of Oxford, Oxford, United Kingdom.",
            "paragraph_rank": 62,
            "section_rank": 22,
            "ref_spans": [
                {
                    "type": "bibr",
                    "ref_id": "b4",
                    "start": 140,
                    "text": "3",
                    "end": 141
                },
                {
                    "type": "bibr",
                    "ref_id": "b5",
                    "start": 229,
                    "text": "4",
                    "end": 230
                },
                {
                    "type": "bibr",
                    "ref_id": "b6",
                    "start": 306,
                    "text": "5",
                    "end": 307
                },
                {
                    "type": "bibr",
                    "ref_id": "b7",
                    "start": 384,
                    "text": "6",
                    "end": 385
                },
                {
                    "type": "bibr",
                    "ref_id": "b8",
                    "start": 476,
                    "text": "7",
                    "end": 477
                },
                {
                    "type": "bibr",
                    "ref_id": "b9",
                    "start": 550,
                    "text": "8",
                    "end": 551
                },
                {
                    "type": "bibr",
                    "ref_id": "b10",
                    "start": 584,
                    "text": "9",
                    "end": 585
                },
                {
                    "type": "bibr",
                    "ref_id": "b11",
                    "start": 638,
                    "text": "10",
                    "end": 640
                },
                {
                    "type": "bibr",
                    "ref_id": "b12",
                    "start": 713,
                    "text": "11",
                    "end": 715
                },
                {
                    "type": "bibr",
                    "ref_id": "b13",
                    "start": 765,
                    "text": "12",
                    "end": 767
                }
            ]
        }
    ]
}